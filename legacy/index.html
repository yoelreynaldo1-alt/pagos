<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeekPay Driver Pro - Facturaci칩n</title>

    <!-- PWA & Mobile Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WeekPay">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">

    <!-- Tailwind CSS para dise침o moderno -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fuentes Google (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Ajustes espec칤ficos */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Ocultar scrollbar en modal pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Estilos de Impresi칩n - CR칈TICOS para el PDF */
        @media print {
            body * {
                visibility: hidden;
            }

            #invoice-preview,
            #invoice-preview *,
            #view-install,
            #view-install * {
                visibility: visible;
            }

            #view-install {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            /* Si estamos imprimiendo la gu칤a, ocultar factura */
            body.print-install #invoice-preview {
                display: none;
            }

            body.print-invoice #view-install {
                display: none;
            }

            .no-print {
                display: none !important;
            }

            /* Asegurar colores de fondo */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* Efecto de hoja de papel */
        .invoice-sheet {
            background: white;
            width: 100%;
            min-height: 297mm;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* CSS iPhone Mockup */
        .iphone-frame {
            border: 12px solid #282828;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            background: #f2f2f2;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0 auto;
        }

        .iphone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 24px;
            background: #282828;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 10;
        }

        .iphone-bar {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .safari-bar {
            background: white;
            border-top: 1px solid #e5e5e5;
            padding: 8px 16px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: absolute;
            bottom: 0;
            width: 100%;
            color: #007AFF;
        }

        .share-sheet {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #f9f9f9;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 16px;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .app-icon-mock {
            width: 48px;
            height: 48px;
            background: #2563eb;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- BARRA LATERAL (Formulario) -->
    <aside
        class="w-full md:w-[450px] bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-lg no-print overflow-hidden">

        <!-- Header del Panel -->
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <div>
                <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                    <i data-lucide="truck" class="w-6 h-6"></i> WeekPay
                </h1>
                <p class="text-xs text-gray-400">Driver Pro</p>
            </div>

            <!-- Tab Switcher -->
            <div class="flex bg-gray-200 p-1 rounded-lg">
                <button onclick="switchTab('invoice')" id="tab-invoice"
                    class="px-3 py-1 rounded-md text-sm font-medium bg-white text-blue-600 shadow-sm transition-all">Facturas</button>
                <button onclick="switchTab('income')" id="tab-income"
                    class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all">Ingresos</button>
                <button onclick="switchTab('install')" id="tab-install"
                    class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all flex items-center gap-1">
                    <i data-lucide="download" class="w-3 h-3"></i> Instalar
                </button>
            </div>

            <button onclick="openSettings()" class="p-2 hover:bg-gray-200 rounded-full transition-colors text-gray-600"
                title="Configuraci칩n">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Contenido Scrollable del Formulario -->
        <div class="flex-1 overflow-y-auto p-5 relative">

            <!-- VISTA FACTURAS (Panel Izquierdo) -->
            <div id="panel-invoice" class="space-y-6 transition-opacity duration-200">
                <!-- Secci칩n: Datos Generales -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Detalles Generales</h3>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Semana del (Lunes)</label>
                        <input type="date" id="weekStartDate" onchange="handleDateChange(this.value)"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">N췈 Factura</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-400">#</span>
                                <input type="number" id="invoiceNumber" oninput="updatePreview()"
                                    class="w-full p-2 pl-7 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Emisi칩n</label>
                            <input type="date" id="invoiceDate" oninput="updatePreview()"
                                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Empresa (Cliente)</label>
                        <input type="text" id="companyName" oninput="updatePreview()"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="Nombre de la empresa">
                    </div>
                </div>

                <!-- Secci칩n: D칤as Trabajados -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end border-b pb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Registro de Actividad</h3>
                        <span id="paymentModeBadge"
                            class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">Por D칤a</span>
                    </div>

                    <div id="daysContainer" class="space-y-2">
                        <!-- Se llena din치micamente con JS -->
                    </div>
                </div>
            </div>

            <!-- VISTA INGRESOS (Panel Izquierdo - Formulario) -->
            <div id="panel-income" class="hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-200">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-green-800 flex items-center gap-2 mb-3">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Nuevo Ingreso
                    </h3>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha de pago</label>
                            <input type="date" id="incDate"
                                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none bg-white">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cliente /
                                Empresa</label>
                            <input type="text" id="incClient" placeholder="Ej: Logistics LLC"
                                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none bg-white">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
                                <select id="incType"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none bg-white"
                                    onchange="toggleIncCalc()">
                                    <option value="day">Por D칤a</option>
                                    <option value="hour">Por Hora</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total ($)</label>
                                <input type="number" id="incAmount" placeholder="0.00"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none font-bold text-green-700 bg-white">
                            </div>
                        </div>

                        <!-- Calculadora r치pida -->
                        <div id="incCalc"
                            class="hidden bg-white p-2 rounded border border-gray-200 grid grid-cols-2 gap-2">
                            <input type="number" id="incHours" placeholder="Horas" class="p-1 border rounded text-sm"
                                oninput="calcIncTotal()">
                            <input type="number" id="incRate" placeholder="Tarifa" class="p-1 border rounded text-sm"
                                oninput="calcIncTotal()">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nota (Opcional)</label>
                            <input type="text" id="incNote" placeholder="Ej: Semana extra"
                                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none bg-white">
                        </div>

                        <button onclick="addIncomeEntry()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors flex justify-center items-center gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i> Guardar Ingreso
                        </button>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Herramientas</h3>
                    <button onclick="exportCSV()"
                        class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-3 rounded-lg flex justify-center items-center gap-2 transition-all text-sm">
                        <i data-lucide="download" class="w-4 h-4 text-gray-500"></i> Exportar Historial (CSV)
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA INSTALAR (Panel Izquierdo - Texto) -->
        <div id="panel-install" class="hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-200">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-5">
                <h3 class="text-lg font-bold text-blue-800 mb-2">Instalar en iPhone</h3>
                <p class="text-sm text-gray-600 leading-relaxed mb-4">
                    Aprovecha al m치ximo WeekPay instalando la App en tu pantalla de inicio.
                    Funciona sin internet y se ve incre칤ble.
                </p>
                <button onclick="openTutorial()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors flex justify-center items-center gap-2">
                    <i data-lucide="play-circle" class="w-4 h-4"></i> Ver Tutorial Interactivo
                </button>
            </div>

            <div class="border-t pt-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Detectar Browser</h4>
                <div id="browser-status" class="text-xs text-gray-500 font-mono bg-gray-100 p-2 rounded border">
                    Detectando...</div>
            </div>
        </div>
        </div>

        <!-- Footer del Panel (Botones) -->
        <div class="p-5 border-t border-gray-200 bg-gray-50 space-y-3">
            <button onclick="window.print()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg flex justify-center items-center gap-2 transition-all shadow-md hover:shadow-lg">
                <i data-lucide="printer" class="w-5 h-5"></i> Descargar PDF / Imprimir
            </button>

            <div class="flex gap-2">
                <button onclick="saveInvoiceAsIncome()"
                    class="bg-green-50 border border-green-200 hover:bg-green-100 text-green-700 text-sm font-semibold py-2 px-2 rounded-lg flex justify-center items-center gap-1 transition-all"
                    title="Guardar como Ingreso">
                    <i data-lucide="save" class="w-4 h-4"></i>
                </button>
                <button onclick="sendEmail('web')"
                    class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-semibold py-2 px-2 rounded-lg flex justify-center items-center gap-2 transition-all"
                    title="Abre Gmail en el navegador">
                    <i data-lucide="globe" class="w-4 h-4 text-red-500"></i> Gmail Web
                </button>
                <button onclick="sendEmail('app')"
                    class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-semibold py-2 px-2 rounded-lg flex justify-center items-center gap-2 transition-all"
                    title="Abre la App de Correo de tu dispositivo">
                    <i data-lucide="smartphone" class="w-4 h-4 text-blue-500"></i> App Correo
                </button>
            </div>
            <div class="text-[10px] text-gray-400 text-center px-2">
                *El email incluir치 un desglose detallado de los d칤as.
            </div>
        </div>
    </aside>

    <!-- 츼REA PRINCIPAL (Vista Previa / Dashboard) -->
    <main class="flex-1 bg-gray-100 overflow-y-auto p-4 md:p-8 flex justify-center no-scrollbar">

        <!-- Hoja de Factura -->
        <div id="view-invoice"
            class="invoice-sheet max-w-[210mm] p-10 md:p-12 text-gray-800 text-sm leading-normal transition-opacity duration-200">

            <!-- Encabezado Factura -->
            <div class="flex justify-between items-start border-b-2 border-blue-600 pb-6 mb-8">
                <div>
                    <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">INVOICE</h1>
                    <p class="text-gray-500 mt-1">Servicios de Transporte</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Invoice No.</div>
                    <div class="text-2xl font-bold text-gray-900 mb-2" id="prevNumber">0000</div>
                    <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Fecha</div>
                    <div class="text-gray-700 font-medium" id="prevDate">--/--/----</div>
                </div>
            </div>

            <!-- Datos Emisor / Receptor -->
            <div class="grid grid-cols-2 gap-8 mb-10">
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Facturar a (Cliente)</h4>
                    <div class="text-lg font-bold text-gray-900" id="prevCompany">Nombre Compa침칤a</div>
                    <div class="text-gray-600" id="prevCompanyEmail">email@compania.com</div>
                </div>
                <div class="text-right">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Enviado por (Chofer)</h4>
                    <div class="text-lg font-bold text-gray-900" id="prevDriver">Tu Nombre</div>
                    <div class="text-gray-600" id="prevAddress">Direcci칩n</div>
                    <div class="text-gray-600" id="prevCity">Ciudad, Estado</div>
                    <div class="text-gray-600 mt-1" id="prevDriverEmail">tuemail@ejemplo.com</div>
                </div>
            </div>

            <!-- Tabla de Detalles -->
            <table class="w-full mb-8">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-bold text-gray-600 uppercase text-xs">Descripci칩n / Fecha
                        </th>
                        <th class="text-right py-3 px-4 font-bold text-gray-600 uppercase text-xs">Horas/Tarifa</th>
                        <th class="text-right py-3 px-4 font-bold text-gray-600 uppercase text-xs">Total</th>
                    </tr>
                </thead>
                <tbody id="invoiceRows" class="text-gray-700">
                    <!-- Filas JS -->
                </tbody>
            </table>

            <!-- Totales -->
            <div class="flex justify-end pt-4 border-t-2 border-gray-100">
                <div class="w-1/2 md:w-1/3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600 font-medium">Subtotal</span>
                        <span class="font-bold" id="prevSubtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center py-4 border-t border-gray-200">
                        <span class="text-xl font-bold text-blue-700">TOTAL</span>
                        <span class="text-2xl font-extrabold text-blue-700" id="prevTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Notas / Pie -->
            <div class="mt-12 pt-8 border-t border-gray-200 text-center">
                <p class="text-gray-500 text-xs italic">Gracias por su confianza. El pago se debe realizar semanalmente
                    seg칰n los t칠rminos acordados.</p>
            </div>

        </div>

        <!-- Vista Dashboard Ingresos (Oculta por defecto) -->
        <div id="view-income" class="w-full hidden flex justify-center translate-x-4 transition-all">
            <!-- Se llena con JS -->
        </div>

        <!-- VISTA GU칈A INSTALACI칍N (Imprimible) -->
        <div id="view-install"
            class="hidden w-full max-w-[210mm] mx-auto bg-white p-10 md:p-12 shadow-lg animate-in fade-in zoom-in duration-300">
            <div class="flex justify-between items-center border-b pb-4 mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <img src="/icons/icon-192.png" class="w-8 h-8 rounded-lg" onerror="this.style.display='none'">
                        Gu칤a de Instalaci칩n
                    </h1>
                    <p class="text-gray-500 text-sm mt-1">WeekPay Driver Pro para iOS</p>
                </div>
                <button onclick="printInstallGuide()"
                    class="no-print bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg flex items-center gap-2 text-sm font-semibold transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i> Imprimir Gu칤a
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Paso 1 -->
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                            1</div>
                        <h3 class="font-bold text-gray-800">Abrir en Safari</h3>
                    </div>
                    <p class="text-sm text-gray-600">Abre <span class="font-mono text-blue-600">weekpay.app</span> en el
                        navegador Safari de tu iPhone. No funciona en Chrome ni Google App.</p>
                    <!-- Mockup Safari -->
                    <div class="iphone-frame" style="width: 200px; height: 300px;">
                        <div class="iphone-notch"></div>
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-50 text-gray-300">
                            WeekPay
                        </div>
                        <div class="safari-bar" style="bottom:0;">
                            <i data-lucide="chevron-left" class="w-4 h-4 text-blue-500"></i>
                            <div class="text-[10px] text-black">weekpay.app</div>
                            <i data-lucide="book" class="w-4 h-4 text-blue-500"></i>
                        </div>
                    </div>
                </div>

                <!-- Paso 2 -->
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                            2</div>
                        <h3 class="font-bold text-gray-800">Tocar bot칩n Compartir</h3>
                    </div>
                    <p class="text-sm text-gray-600">Busca el icono cuadrado con la flecha hacia arriba en la barra
                        inferior.</p>
                    <div class="iphone-frame" style="width: 200px; height: 300px;">
                        <div class="safari-bar" style="bottom: 0px;">
                            <i data-lucide="chevron-left" class="w-4 h-4 text-gray-300"></i>
                            <div class="p-1 rounded bg-blue-100 animate-pulse">
                                <i data-lucide="share" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <i data-lucide="book" class="w-4 h-4 text-gray-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Paso 3 -->
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                            3</div>
                        <h3 class="font-bold text-gray-800">A침adir a Inicio</h3>
                    </div>
                    <p class="text-sm text-gray-600">Desliza hacia arriba en el men칰 y selecciona la opci칩n "A침adir a
                        pantalla de inicio".</p>
                    <div class="iphone-frame" style="width: 200px; height: 300px;">
                        <div class="share-sheet" style="padding: 10px;">
                            <div class="flex items-center gap-2 mb-2 p-2 bg-gray-100 rounded">
                                <span class="text-xs font-bold">WeekPay</span>
                            </div>
                            <div class="space-y-1">
                                <div class="p-2 border-b text-[10px] text-gray-400">Copiar</div>
                                <div
                                    class="p-2 border-b text-[10px] flex items-center gap-2 font-bold bg-blue-50 text-blue-800 rounded">
                                    <i data-lucide="plus-square" class="w-3 h-3"></i> A침adir a inicio
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 4 -->
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                            4</div>
                        <h3 class="font-bold text-gray-800">Confirmar</h3>
                    </div>
                    <p class="text-sm text-gray-600">Toca "A침adir" en la esquina superior derecha. 춰Listo!</p>
                    <div class="iphone-frame" style="width: 200px; height: 300px;">
                        <div
                            class="absolute top-0 w-full bg-gray-100 p-3 border-b flex justify-between items-center text-[10px]">
                            <span class="text-blue-500">Cancelar</span>
                            <span class="font-bold">A침adir a inicio</span>
                            <span class="font-bold text-blue-600">A침adir</span>
                        </div>
                        <div class="mt-14 flex flex-col items-center">
                            <div class="app-icon-mock mb-2">
                                <i data-lucide="truck" class="w-6 h-6 text-white"></i>
                            </div>
                            <span class="text-xs font-bold">WeekPay</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-10 p-4 bg-gray-50 rounded-lg text-center text-xs text-gray-500">
                <p>WeekPay Driver Pro - Documento generado autom치ticamente.</p>
            </div>
        </div>

    </main>

    <!-- MODAL DE CONFIGURACI칍N / BIENVENIDA -->
    <div id="welcomeModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200">

            <div class="bg-blue-600 p-6 text-center text-white">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="user" class="w-6 h-6 text-white"></i>
                </div>
                <h2 class="text-xl font-bold">Perfil del Conductor</h2>
                <p class="text-blue-100 text-sm">Configura tus datos predeterminados</p>
            </div>

            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre Completo</label>
                    <input type="text" id="modalDriverName"
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Ej: Juan P칠rez">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                        <input type="email" id="modalDriverEmail"
                            class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email Compa침칤a</label>
                        <input type="email" id="modalCompanyEmail"
                            class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="pagos@empresa.com">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Direcci칩n</label>
                        <input type="text" id="modalAddress"
                            class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ciudad / Estado</label>
                        <input type="text" id="modalCity"
                            class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">M칠todo de Pago</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="setTempMode('day')" id="optDay"
                            class="cursor-pointer border-2 rounded-lg p-3 text-center hover:bg-blue-50 transition-colors">
                            <i data-lucide="calendar" class="w-5 h-5 mx-auto mb-1 text-gray-600"></i>
                            <span class="text-sm font-bold">Por D칤a</span>
                        </div>
                        <div onclick="setTempMode('hour')" id="optHour"
                            class="cursor-pointer border-2 rounded-lg p-3 text-center hover:bg-blue-50 transition-colors">
                            <i data-lucide="clock" class="w-5 h-5 mx-auto mb-1 text-gray-600"></i>
                            <span class="text-sm font-bold">Por Hora</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="lblRate">Tarifa
                        Predeterminada ($)</label>
                    <input type="number" id="modalRate"
                        class="w-full p-3 border-2 border-gray-200 rounded-lg text-lg font-bold text-center focus:border-blue-500 outline-none"
                        placeholder="0.00">
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t flex gap-3">
                <button onclick="closeModal()"
                    class="flex-1 py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-100 text-gray-600 font-semibold transition-colors">Cancelar</button>
                <button onclick="saveSettings()"
                    class="flex-1 py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-lg transition-colors">Guardar
                    Cambios</button>
            </div>
        </div>
    </div>

    <!-- TUTORIAL OVERLAY (Simulaci칩n) -->
    <div id="installTutorialModal"
        class="fixed inset-0 bg-black/90 z-[60] hidden flex flex-col items-center justify-center p-6 backdrop-blur-sm">
        <button onclick="closeTutorial()" class="absolute top-4 right-4 text-white hover:text-gray-300">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>

        <div class="w-full max-w-sm text-center">

            <div id="step-carousel" class="relative min-h-[420px] mb-8">
                <!-- STEP 1 -->
                <div class="step-content transition-all duration-300 absolute inset-0 opacity-100" data-step="1">
                    <h2 class="text-2xl font-bold text-white mb-2">Paso 1: Usa Safari</h2>
                    <p class="text-gray-300 mb-6">Esta instalaci칩n solo funciona en el navegador Safari.</p>

                    <div class="iphone-frame mx-auto" style="width: 260px; height: 320px;">
                        <div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50">
                            <div class="text-4xl">游빐</div>
                            <div class="mt-2 text-sm font-bold text-gray-800">Safari</div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2 -->
                <div class="step-content transition-all duration-300 absolute inset-0 opacity-0 pointer-events-none"
                    data-step="2">
                    <h2 class="text-2xl font-bold text-white mb-2">Paso 2: Bot칩n Compartir</h2>
                    <p class="text-gray-300 mb-6">Toca el icono cuadrado con flecha en la barra inferior.</p>

                    <div class="iphone-frame mx-auto" style="width: 260px; height: 320px;">
                        <div class="safari-bar" style="bottom: 0;">
                            <i data-lucide="chevron-left" class="w-5 h-5 text-gray-300"></i>
                            <div class="bg-blue-100 p-2 rounded-lg animate-bounce">
                                <i data-lucide="share" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <i data-lucide="book" class="w-5 h-5 text-gray-300"></i>
                        </div>
                        <div class="absolute bottom-16 left-0 right-0 text-center text-xs text-blue-600 font-bold">
                            游녢 춰Toca aqu칤!
                        </div>
                    </div>
                </div>

                <!-- STEP 3 -->
                <div class="step-content transition-all duration-300 absolute inset-0 opacity-0 pointer-events-none"
                    data-step="3">
                    <h2 class="text-2xl font-bold text-white mb-2">Paso 3: A침adir a Inicio</h2>
                    <p class="text-gray-300 mb-6">Desliza el men칰 hacia arriba y busca esta opci칩n.</p>

                    <div class="iphone-frame mx-auto" style="width: 260px; height: 320px;">
                        <div class="share-sheet h-3/4 flex flex-col">
                            <div class="flex-1 space-y-2 pt-4">
                                <div class="p-3 border-b text-xs text-gray-400">Copiar enlace</div>
                                <div
                                    class="p-3 bg-gray-100 rounded-lg flex items-center gap-3 font-bold text-gray-800 border-2 border-blue-500 shadow-lg transform scale-105">
                                    <div class="bg-gray-300 rounded p-1"><i data-lucide="plus-square"
                                            class="w-4 h-4"></i></div>
                                    A침adir a inicio
                                </div>
                                <div class="p-3 border-b text-xs text-gray-400">Buscar en p치gina</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 4 -->
                <div class="step-content transition-all duration-300 absolute inset-0 opacity-0 pointer-events-none"
                    data-step="4">
                    <h2 class="text-2xl font-bold text-white mb-2">Paso 4: 춰Listo!</h2>
                    <p class="text-gray-300 mb-6">Confirma tocando "A침adir" arriba a la derecha.</p>

                    <div class="iphone-frame mx-auto" style="width: 260px; height: 320px;">
                        <div
                            class="absolute top-0 w-full bg-gray-100 p-4 border-b flex justify-between items-center text-sm z-20">
                            <span class="text-blue-500">Cancelar</span>
                            <span class="font-bold">A침adir a inicio</span>
                            <div class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse">
                                A침adir</div>
                        </div>
                        <div class="mt-20 flex flex-col items-center">
                            <div class="app-icon-mock mb-3 scale-125">
                                <i data-lucide="truck" class="w-8 h-8 text-white"></i>
                            </div>
                            <span class="font-bold">WeekPay</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-2 mt-4">
                <button onclick="prevStep()"
                    class="p-2 rounded-full bg-white/10 hover:bg-white/20 text-white transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div class="flex items-center gap-2 px-4">
                    <span id="step-indicator" class="text-white font-mono">1 / 4</span>
                </div>
                <button onclick="nextStep()"
                    class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 text-white shadow-lg transition-transform active:scale-95">
                    <i data-lucide="arrow-right" class="w-6 h-6"></i>
                </button>
            </div>

        </div>
    </div>

    <script>
        // --- ESTADO Y CONFIGURACI칍N ---
        let appState = {
            driverName: '',
            driverEmail: '',
            address: '',
            city: '',
            companyEmail: '',
            companyName: '',
            paymentMode: 'day', // 'day' | 'hour'
            defaultRate: 0,
            invoiceNumber: '',
            currentWeekStart: null, // Objeto Date del Lunes
            days: [],
            incomeEntries: []
        };

        const dayNames = ['Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado', 'Domingo'];
        const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        let tempMode = 'day'; // Para el modal
        let currentTab = 'invoice';

        // --- INICIALIZACI칍N ---
        window.onload = function () {
            lucide.createIcons();

            // Cargar datos persistentes
            loadFromStorage();

            // Establecer fecha de la semana (por defecto al Lunes actual o anterior)
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 Dom, 1 Lun
            // Ajuste para que Lunes sea 0 y Domingo 6 para c치lculo f치cil
            const diff = today.getDate() - dayOfWeek + (dayOfWeek == 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));

            // Setear el input date al Lunes calculado
            document.getElementById('weekStartDate').valueAsDate = monday;

            // Generar los datos de la semana
            handleDateChange(document.getElementById('weekStartDate').value);

            // Setear fecha factura hoy
            if (!document.getElementById('invoiceDate').value) {
                document.getElementById('invoiceDate').valueAsDate = new Date();
            }

            // Si no hay nombre, abrir modal
            if (!appState.driverName) {
                openSettings();
            } else {
                renderUI();
            }

            // Renderizar Dashboard Inical
            renderIncomeDashboard();

            // Setear fecha hoy en income form
            document.getElementById('incDate').value = new Date().toISOString().split('T')[0];
        };

        // --- TAB SWITCHER & LOGIC ---
        function switchTab(tabName) {
            currentTab = tabName;

            const viewInc = document.getElementById('view-income');
            const viewInst = document.getElementById('view-install'); // NEW

            // Buttons
            const tabInv = document.getElementById('tab-invoice');
            const tabInc = document.getElementById('tab-income');
            const tabInst = document.getElementById('tab-install'); // NEW

            const panelInv = document.getElementById('panel-invoice');
            const panelInc = document.getElementById('panel-income');
            const panelInst = document.getElementById('panel-install'); // NEW

            // Hide all first
            [viewInv, viewInc, viewInst].forEach(el => el?.classList.add('hidden'));
            [panelInv, panelInc, panelInst].forEach(el => el?.classList.add('hidden'));

            // Reset styles
            const inactiveClass = "px-3 py-1 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition-all flex items-center gap-1";
            const activeClass = "px-3 py-1 rounded-md text-sm font-medium bg-white text-blue-600 shadow-sm transition-all flex items-center gap-1";

            if (tabInv) tabInv.className = inactiveClass.replace('flex items-center gap-1', ''); // restore original generic style if needed
            if (tabInc) tabInc.className = inactiveClass.replace('flex items-center gap-1', '');
            if (tabInst) tabInst.className = inactiveClass;

            if (tabName === 'invoice') {
                tabInv.className = "px-3 py-1 rounded-md text-sm font-medium bg-white text-blue-600 shadow-sm transition-all";
                panelInv.classList.remove('hidden');
                viewInv.classList.remove('hidden');
                document.body.className = "h-screen overflow-hidden flex flex-col md:flex-row print-invoice";
            } else if (tabName === 'income') {
                tabInc.className = "px-3 py-1 rounded-md text-sm font-medium bg-white text-green-700 shadow-sm transition-all";
                panelInc.classList.remove('hidden');
                viewInc.classList.remove('hidden');
                renderIncomeDashboard();
            } else if (tabName === 'install') {
                tabInst.className = activeClass;
                panelInst.classList.remove('hidden');
                viewInst.classList.remove('hidden');
                document.body.className = "h-screen overflow-hidden flex flex-col md:flex-row print-install";
                updateBrowserStatus();
            }
        }

        function toggleIncCalc() {
            const type = document.getElementById('incType').value;
            const calc = document.getElementById('incCalc');
            const amountInput = document.getElementById('incAmount');

            if (type === 'hour') {
                calc.classList.remove('hidden');
                amountInput.readOnly = true;
                amountInput.classList.add('bg-gray-100');
            } else {
                calc.classList.add('hidden');
                amountInput.readOnly = false;
                amountInput.classList.remove('bg-gray-100');
                document.getElementById('incHours').value = '';
                document.getElementById('incRate').value = '';
            }
        }

        function calcIncTotal() {
            const hrs = parseFloat(document.getElementById('incHours').value) || 0;
            const rate = parseFloat(document.getElementById('incRate').value) || 0;
            document.getElementById('incAmount').value = (hrs * rate).toFixed(2);
        }

        function addIncomeEntry() {
            const date = document.getElementById('incDate').value;
            const amount = parseFloat(document.getElementById('incAmount').value);
            const client = document.getElementById('incClient').value;

            if (!date || !amount || amount <= 0) {
                return alert('Por favor ingresa fecha v치lida y monto mayor a 0.');
            }

            const entry = {
                id: Date.now(),
                dateISO: date,
                client: client || 'Sin cliente',
                payType: document.getElementById('incType').value,
                hours: document.getElementById('incHours').value,
                rate: document.getElementById('incRate').value,
                total: amount,
                note: document.getElementById('incNote').value,
                createdAt: new Date().toISOString()
            };

            appState.incomeEntries.push(entry);
            saveToStorage();

            document.getElementById('incAmount').value = '';
            document.getElementById('incNote').value = '';
            alert('Ingreso guardado correctamente.');
            renderIncomeDashboard();
        }

        function deleteIncomeEntry(id) {
            if (!confirm('쯉eguro que deseas eliminar este registro?')) return;
            appState.incomeEntries = appState.incomeEntries.filter(e => e.id !== id);
            saveToStorage();
            renderIncomeDashboard();
        }

        function renderIncomeDashboard() {
            const container = document.getElementById('view-income');
            if (!container) return;

            const selectedYear = parseInt(document.getElementById('filterYear')?.value) || new Date().getFullYear();
            const yearEntries = appState.incomeEntries.filter(e => new Date(e.dateISO).getFullYear() === selectedYear);

            const totalYear = yearEntries.reduce((acc, curr) => acc + curr.total, 0);

            const currentMonth = new Date().getMonth();
            const currentMonthEntries = yearEntries.filter(e => new Date(e.dateISO).getMonth() === currentMonth);
            const totalMonth = currentMonthEntries.reduce((acc, curr) => acc + curr.total, 0);

            const monthlyTotals = new Array(12).fill(0);
            yearEntries.forEach(e => {
                monthlyTotals[new Date(e.dateISO).getMonth()] += e.total;
            });

            container.innerHTML = `
                <div class="w-full max-w-4xl animate-in fade-in zoom-in duration-300">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Registro de Salarios</h2>
                        <select id="filterYear" onchange="renderIncomeDashboard()" class="p-2 border rounded-lg bg-white shadow-sm font-semibold text-gray-700">
                            ${getLast5YearsOptions(selectedYear)}
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                            <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Este Mes (${months[currentMonth]})</div>
                            <div class="text-3xl font-extrabold text-blue-600">$${totalMonth.toFixed(2)}</div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                            <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Total A침o ${selectedYear}</div>
                            <div class="text-3xl font-extrabold text-green-600">$${totalYear.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8 overflow-x-auto">
                        <h3 class="text-sm font-bold text-gray-700 mb-4">Resumen Mensual</h3>
                        <div class="flex gap-4 min-w-max">
                            ${monthlyTotals.map((total, idx) => `
                                <div class="text-center min-w-[60px]">
                                    <div class="h-24 flex items-end justify-center mb-2 bg-gray-50 rounded-t-lg relative group">
                                        <div style="height: ${totalYear > 0 ? (total / totalYear) * 100 : 0}%" class="w-full bg-blue-200 rounded-t-lg group-hover:bg-blue-300 transition-all relative">
                                            <span class="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs p-1 rounded">$${total.toFixed(0)}</span>
                                        </div>
                                    </div>
                                    <div class="text-xs font-bold text-gray-500">${months[idx].slice(0, 3)}</div>
                                    <div class="text-xs text-gray-800 font-semibold mt-1">$${total > 0 ? (total / 1000).toFixed(1) + 'k' : '0'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-gray-800">Historial Detallado</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-3">Fecha</th>
                                        <th class="px-4 py-3">Cliente</th>
                                        <th class="px-4 py-3">Tipo</th>
                                        <th class="px-4 py-3 text-right">Monto</th>
                                        <th class="px-4 py-3 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${yearEntries.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO)).map(entry => `
                                        <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-4 py-3 text-gray-900 font-medium">
                                                ${new Date(entry.dateISO + 'T00:00:00').toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })}
                                            </td>
                                            <td class="px-4 py-3 text-gray-600">
                                                ${entry.client}
                                                ${entry.note ? `<div class="text-xs text-gray-400 italic">${entry.note}</div>` : ''}
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-0.5 rounded-full text-xs ${entry.payType === 'day' ? 'bg-blue-50 text-blue-700' : 'bg-orange-50 text-orange-700'}">
                                                    ${entry.payType === 'day' ? 'D칤a' : 'Hora'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-right font-bold text-gray-800">
                                                $${entry.total.toFixed(2)}
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <button onclick="deleteIncomeEntry(${entry.id})" class="text-red-400 hover:text-red-600 p-1 rounded-md hover:bg-red-50">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">No hay registros este a침o.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function getLast5YearsOptions(selected) {
            const current = new Date().getFullYear();
            let opts = '';
            for (let i = 0; i < 5; i++) {
                const y = current - i;
                opts += `<option value="${y}" ${y === selected ? 'selected' : ''}>${y}</option>`;
            }
            return opts;
        }

        function saveInvoiceAsIncome() {
            const totalText = document.getElementById('prevTotal').textContent.replace('$', '').trim();
            const total = parseFloat(totalText);

            if (!total || total <= 0) return alert('No hay monto para guardar.');

            if (!confirm(`쮾uardar factura actual por $${total} en Ingresos?`)) return;

            const date = document.getElementById('invoiceDate').value;
            const client = document.getElementById('companyName').value;
            const invNum = document.getElementById('invoiceNumber').value;

            const entry = {
                id: Date.now(),
                dateISO: date,
                client: client || 'Factura #' + invNum,
                payType: 'day',
                hours: '',
                rate: '',
                total: total,
                note: `Importado de Factura #${invNum}`,
                createdAt: new Date().toISOString()
            };

            appState.incomeEntries.push(entry);
            saveToStorage();

            alert('Guardado en historial de ingresos.');
        }

        function exportCSV() {
            const rows = [['ID', 'Fecha', 'Cliente', 'Tipo', 'Total', 'Nota']];
            appState.incomeEntries.forEach(e => {
                rows.push([e.id, e.dateISO, e.client, e.payType, e.total, e.note || '']);
            });
            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "weekpay_ingresos.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- L칍GICA DE FECHAS ---
        function handleDateChange(dateString) {
            if (!dateString) return;

            const selectedDate = new Date(dateString + 'T00:00:00'); // Forzar hora local
            // Encontrar el lunes de esa semana seleccionada
            const day = selectedDate.getDay();
            const diff = selectedDate.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(selectedDate.setDate(diff));

            appState.currentWeekStart = monday;
            generateDays(monday);
            renderDaysTable();
            updatePreview();
        }

        function generateDays(monday) {
            // Preservar datos si cambiamos de semana? Por simplicidad, reiniciamos estructura
            // pero podr칤amos intentar mapear si quisi칠ramos persistencia compleja.
            // Aqu칤 reiniciamos para evitar errores de fechas cruzadas.

            appState.days = dayNames.map((name, index) => {
                let d = new Date(monday);
                d.setDate(monday.getDate() + index);

                return {
                    id: index,
                    label: name,
                    dateObj: d,
                    dateStr: d.toISOString().split('T')[0],
                    active: index < 5, // L-V activo
                    hours: '',
                    amount: ''
                };
            });

            // Aplicar tarifa por defecto a d칤as activos si es por d칤a
            if (appState.paymentMode === 'day' && appState.defaultRate) {
                appState.days.forEach(d => { if (d.active) d.amount = appState.defaultRate; });
            }
        }

        // --- RENDERIZADO UI (FORMULARIO) ---
        function renderDaysTable() {
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';

            const isHour = appState.paymentMode === 'hour';
            document.getElementById('paymentModeBadge').textContent = isHour ? 'Por Hora' : 'Por D칤a';

            appState.days.forEach((day, index) => {
                const dayDiv = document.createElement('div');
                dayDiv.className = `flex items-center gap-2 p-2 rounded-lg border transition-all ${day.active ? 'bg-white border-blue-200 shadow-sm' : 'bg-gray-50 border-gray-100 opacity-60'}`;

                // Formatear fecha bonita: "04/08"
                const datePretty = day.dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });

                dayDiv.innerHTML = `
                    <div class="flex items-center justify-center pt-1">
                        <input type="checkbox" ${day.active ? 'checked' : ''} 
                            onchange="toggleDay(${index}, this.checked)"
                            class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                    </div>
                    
                    <div class="w-24 text-sm">
                        <div class="font-bold text-gray-700">${day.label.slice(0, 3)}</div>
                        <div class="text-xs text-gray-400">${datePretty}</div>
                    </div>

                    ${isHour ? `
                        <div class="flex-1">
                            <input type="number" value="${day.hours}" placeholder="Hrs" 
                                ${!day.active ? 'disabled' : ''}
                                oninput="updateDayData(${index}, 'hours', this.value)"
                                class="w-full p-1 text-sm border rounded focus:border-blue-500 outline-none text-center bg-transparent">
                        </div>
                    ` : ''}

                    <div class="flex-1 relative">
                        <span class="absolute left-2 top-1.5 text-gray-400 text-xs">$</span>
                        <input type="number" value="${day.amount}" placeholder="0.00" 
                            ${(!day.active || isHour) ? 'disabled' : ''} 
                            oninput="updateDayData(${index}, 'amount', this.value)"
                            class="w-full p-1 pl-5 text-sm font-semibold text-right border rounded focus:border-blue-500 outline-none bg-transparent ${isHour ? 'bg-gray-100' : ''}">
                    </div>
                `;
                container.appendChild(dayDiv);
            });
        }

        // --- L칍GICA DE NEGOCIO ---
        function toggleDay(index, isActive) {
            appState.days[index].active = isActive;

            if (isActive && appState.paymentMode === 'day' && appState.defaultRate && !appState.days[index].amount) {
                appState.days[index].amount = appState.defaultRate;
            }
            if (isActive && appState.paymentMode === 'hour' && appState.days[index].hours) {
                // Recalcular si ya hab칤a horas
                const h = parseFloat(appState.days[index].hours) || 0;
                appState.days[index].amount = (h * parseFloat(appState.defaultRate)).toFixed(2);
            }

            renderDaysTable();
            updatePreview();
        }

        function updateDayData(index, field, value) {
            appState.days[index][field] = value;

            // Auto-c치lculo para modo Hora
            if (appState.paymentMode === 'hour' && field === 'hours') {
                const h = parseFloat(value) || 0;
                const r = parseFloat(appState.defaultRate) || 0;
                appState.days[index].amount = (h * r).toFixed(2);
                // No re-renderizamos toda la tabla para no perder el foco del input
                // pero actualizamos el input de amount manualmente
                // Sin embargo, como el input amount est치 disabled en modo hora, visualmente se actualizar치 al refrescar o podriamos forzarlo
                // Para simplicidad, refrescamos el preview solamente.
                renderDaysTable();
                // Hack para devolver el foco (simplificado, en app real usar칤amos refs)
            }

            updatePreview();
        }

        function updatePreview() {
            // 1. Sincronizar inputs generales al estado (solo los que no son del modal)
            appState.companyName = document.getElementById('companyName').value;
            appState.invoiceNumber = document.getElementById('invoiceNumber').value;

            // 2. Renderizar Datos Preview
            document.getElementById('prevNumber').textContent = appState.invoiceNumber || '0000';

            const dVal = document.getElementById('invoiceDate').value;
            document.getElementById('prevDate').textContent = dVal ? new Date(dVal + 'T00:00:00').toLocaleDateString('es-ES') : '--/--/----';

            document.getElementById('prevCompany').textContent = appState.companyName || 'Nombre del Cliente';
            document.getElementById('prevCompanyEmail').textContent = appState.companyEmail;

            document.getElementById('prevDriver').textContent = appState.driverName || 'Tu Nombre';
            document.getElementById('prevDriverEmail').textContent = appState.driverEmail;
            document.getElementById('prevAddress').textContent = appState.address;
            document.getElementById('prevCity').textContent = appState.city;

            // 3. Renderizar Filas
            const tbody = document.getElementById('invoiceRows');
            tbody.innerHTML = '';
            let total = 0;

            appState.days.forEach(day => {
                if (!day.active) return;

                const amt = parseFloat(day.amount) || 0;
                total += amt;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-gray-50";

                let desc = `<span class="font-medium text-gray-900">${day.label}</span>`;
                desc += `<div class="text-xs text-gray-500">${new Date(day.dateStr + 'T00:00:00').toLocaleDateString('es-ES')}</div>`;

                let details = '';
                if (appState.paymentMode === 'hour') {
                    details = `${day.hours || 0} hrs <span class="text-xs text-gray-400">x $${appState.defaultRate}</span>`;
                } else {
                    details = 'Tarifa Diaria';
                }

                tr.innerHTML = `
                    <td class="py-3 px-4">${desc}</td>
                    <td class="py-3 px-4 text-right">${details}</td>
                    <td class="py-3 px-4 text-right font-medium">$${amt.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('prevSubtotal').textContent = '$' + total.toFixed(2);
            document.getElementById('prevTotal').textContent = '$' + total.toFixed(2);

            saveToStorage();
        }

        // --- MODAL Y SETTINGS ---
        function openSettings() {
            // Cargar valores actuales en inputs del modal
            document.getElementById('modalDriverName').value = appState.driverName;
            document.getElementById('modalDriverEmail').value = appState.driverEmail;
            document.getElementById('modalCompanyEmail').value = appState.companyEmail;
            document.getElementById('modalAddress').value = appState.address;
            document.getElementById('modalCity').value = appState.city;
            document.getElementById('modalRate').value = appState.defaultRate;
            setTempMode(appState.paymentMode);

            document.getElementById('welcomeModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('welcomeModal').classList.add('hidden');
        }

        function setTempMode(mode) {
            tempMode = mode;
            const optDay = document.getElementById('optDay');
            const optHour = document.getElementById('optHour');

            // Reset styles
            [optDay, optHour].forEach(el => {
                el.className = "cursor-pointer border-2 rounded-lg p-3 text-center hover:bg-blue-50 transition-colors border-gray-200 text-gray-600";
            });

            // Active style
            const active = mode === 'day' ? optDay : optHour;
            active.className = "cursor-pointer border-2 rounded-lg p-3 text-center bg-blue-50 border-blue-600 text-blue-700 shadow-sm";

            document.getElementById('lblRate').textContent = mode === 'day' ? 'Tarifa por D칤a ($)' : 'Tarifa por Hora ($)';
        }

        function saveSettings() {
            appState.driverName = document.getElementById('modalDriverName').value;
            appState.driverEmail = document.getElementById('modalDriverEmail').value;
            appState.companyEmail = document.getElementById('modalCompanyEmail').value;
            appState.address = document.getElementById('modalAddress').value;
            appState.city = document.getElementById('modalCity').value;
            appState.defaultRate = document.getElementById('modalRate').value;

            // Si cambi칩 el modo, regenerar c치lculos
            const modeChanged = appState.paymentMode !== tempMode;
            appState.paymentMode = tempMode;

            saveToStorage();
            closeModal();

            if (modeChanged) {
                // Regenerar l칩gica de la tabla
                const dateVal = document.getElementById('weekStartDate').value;
                if (dateVal) handleDateChange(dateVal);
            } else {
                renderDaysTable();
                updatePreview();
            }
        }

        // --- PERSISTENCIA ---
        function saveToStorage() {
            const data = {
                driverName: appState.driverName,
                driverEmail: appState.driverEmail,
                companyEmail: appState.companyEmail,
                companyName: appState.companyName,
                address: appState.address,
                city: appState.city,
                paymentMode: appState.paymentMode,
                defaultRate: appState.defaultRate,
                invoiceNumber: appState.invoiceNumber,
                incomeEntries: appState.incomeEntries || []
            };
            localStorage.setItem('weekpay_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('weekpay_data');
            if (saved) {
                const data = JSON.parse(saved);
                appState = { ...appState, ...data };
                if (!appState.incomeEntries) appState.incomeEntries = []; // Retrocompatibilidad

                // Llenar inputs que est치n fuera del modal
                document.getElementById('companyName').value = appState.companyName || '';
                document.getElementById('invoiceNumber').value = appState.invoiceNumber || (Math.floor(Math.random() * 9000) + 1000);
            } else {
                appState.invoiceNumber = Math.floor(Math.random() * 9000) + 1000;
            }
        }

        function renderUI() {
            // Wrapper para render inicial
            renderDaysTable();
            updatePreview();
        }

        // --- UTILS ---
        function sendEmail(mode) {
            if (!appState.companyEmail) return alert('Por favor configura el email de la compa침칤a en Ajustes.');

            const total = document.getElementById('prevTotal').textContent;
            const weekStr = document.getElementById('weekStartDate').value;
            // Formatear fecha de la semana
            const weekDate = weekStr ? new Date(weekStr + 'T00:00:00') : new Date();
            const weekPretty = weekDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });

            const subject = `Factura #${appState.invoiceNumber} - ${appState.driverName}`;

            // Construcci칩n del cuerpo del correo estilo "Ticket"
            let body = `Hola ${appState.companyName || 'Equipo'},\n\n`;
            body += `Adjunto mi factura #${appState.invoiceNumber} para la semana del ${weekPretty}.\n\n`;

            body += `----------------------------------------\n`;
            body += ` DESGLOSE DE SERVICIOS\n`;
            body += `----------------------------------------\n`;

            appState.days.forEach(day => {
                if (day.active) {
                    // Formato: Lunes (04/08) ...... $150.00
                    const dateObj = new Date(day.dateStr + 'T00:00:00');
                    const dateShort = dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });

                    let rowTitle = `${day.label} (${dateShort})`;

                    // Detalles extra si es por hora
                    if (appState.paymentMode === 'hour') {
                        rowTitle += ` [${day.hours}h]`;
                    }

                    const amount = `$${parseFloat(day.amount).toFixed(2)}`;

                    // Intento de espaciado simple (no perfecto en todos los clientes pero mejor que nada)
                    body += `${rowTitle} - ${amount}\n`;
                }
            });

            body += `----------------------------------------\n`;
            body += ` TOTAL: ${total}\n`;
            body += `----------------------------------------\n\n`;

            body += `Gracias,\n${appState.driverName}`;

            if (mode === 'web') {
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(appState.companyEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(gmailUrl, '_blank');
            } else {
                const mailtoUrl = `mailto:${appState.companyEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;
            }
        }
    </script>

    <!-- iOS Install Banner Enhanced -->
    <div id="ios-install-banner"
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 transform translate-y-full transition-transform duration-300 hidden print:hidden">
        <div class="flex items-start gap-4 mx-auto max-w-md pr-0 relative">
            <button onclick="dismissInstallBanner(true)"
                class="absolute -top-2 -right-2 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-1">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
            <div class="relative">
                <img src="/icons/icon-192.png" class="w-14 h-14 rounded-xl shadow-sm bg-gray-50 flex-shrink-0"
                    alt="WeekPay">
                <div
                    class="absolute -bottom-1 -right-1 bg-blue-600 text-white rounded-full p-0.5 border-2 border-white">
                    <i data-lucide="arrow-down-to-line" class="w-3 h-3"></i>
                </div>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-900 text-sm mb-1 leading-tight">Instala WeekPay en tu iPhone</h3>
                <p class="text-xs text-gray-600 mb-3 leading-snug">Acceso r치pido, sin internet y pantalla completa.</p>
                <div class="flex gap-2">
                    <button onclick="openTutorial()"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1.5 px-3 rounded-lg shadow-sm transition-colors flex items-center gap-1">
                        Ver Gu칤a <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </button>
                    <button onclick="dismissInstallBanner(true)"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs font-semibold py-1.5 px-3 rounded-lg transition-colors">
                        No mostrar m치s
                    </button>
                </div>
            </div>
        </div>

        <!-- Flecha indicadora para el bot칩n compartir -->
        <div class="absolute bottom-1 left-1/2 -translate-x-1/2 translate-y-full text-blue-600 animate-bounce pt-2 hidden md:hidden"
            id="share-arrow">
            <i data-lucide="arrow-down" class="w-6 h-6"></i>
        </div>
    </div>

    <!-- Service Worker & PWA Logic -->
    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registrado:', reg.scope))
                    .catch(err => console.log('SW error:', err));
            });
        }

        // --- INSTALL LOGIC ---

        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isSafari() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.indexOf('safari') > -1 && ua.indexOf('chrome') === -1 && ua.indexOf('crios') === -1;
        }

        function isInStandaloneMode() {
            return ('standalone' in window.navigator) && (window.navigator.standalone);
        }

        function checkBannerPreference() {
            const dismissed = localStorage.getItem('wp_install_dismissed');
            if (dismissed === 'true') return;

            // Mostrar solo en iOS + Safari + No instalado
            if (isIOS() && isSafari() && !isInStandaloneMode()) {
                setTimeout(() => {
                    const banner = document.getElementById('ios-install-banner');
                    if (banner) {
                        banner.classList.remove('hidden');
                        requestAnimationFrame(() => banner.classList.remove('translate-y-full'));
                    }
                }, 2000);
            }
        }

        function dismissInstallBanner(forever) {
            const banner = document.getElementById('ios-install-banner');
            banner.classList.add('translate-y-full');
            if (forever) {
                localStorage.setItem('wp_install_dismissed', 'true');
            }
            setTimeout(() => banner.classList.add('hidden'), 300);
        }

        // --- TUTORIAL LOGIC ---
        let currentStep = 1;
        const totalSteps = 4;

        function openTutorial() {
            if (!isSafari() && isIOS()) {
                alert('Para instalar, por favor abre weekpay.app en el navegador SAFARI.');
                return;
            }
            // Reset
            currentStep = 1;
            updateStep();

            const modal = document.getElementById('installTutorialModal');
            modal.classList.remove('hidden');

            // Si el banner estaba abierto, cerrarlo temporalmente
            dismissInstallBanner(false);
        }

        function closeTutorial() {
            document.getElementById('installTutorialModal').classList.add('hidden');
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                currentStep++;
                updateStep();
            } else {
                closeTutorial();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStep();
            }
        }

        function updateStep() {
            // Update Text & Graphics
            document.querySelectorAll('.step-content').forEach(el => {
                const s = parseInt(el.dataset.step);
                if (s === currentStep) {
                    el.classList.remove('opacity-0', 'pointer-events-none');
                    el.classList.add('opacity-100');
                } else {
                    el.classList.add('opacity-0', 'pointer-events-none');
                    el.classList.remove('opacity-100');
                }
            });

            document.getElementById('step-indicator').textContent = `${currentStep} / ${totalSteps}`;
        }

        function updateBrowserStatus() {
            const el = document.getElementById('browser-status');
            const status = [];
            if (isIOS()) status.push('iOS Detectado');
            else status.push('No es iOS');

            if (isSafari()) status.push('Safari');
            else status.push('No es Safari');

            if (isInStandaloneMode()) status.push('Instalado (PWA)');
            else status.push('Web Browser');

            el.textContent = status.join(' | ');
        }

        function printInstallGuide() {
            // Asegurar que estamos en la tab correcta (ya deber칤a, pero por si acaso)
            // switchTab('install'); // No volver a llamar, podr칤a resetear
            window.print();
        }

        // Init Hook
        window.addEventListener('load', () => {
            checkBannerPreference();
        });
    </script>
</body>

</html>